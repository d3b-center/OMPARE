---
title: "Pediatric Mutational MAF Analysis Graph Conversion"
author: "Run Jin"
date: "8/20/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(dplyr)
# BiocManager::install("maftools", force =TRUE)
library(maftools)

# sample of interest is defined here
pnoc008_sample_of_interest <- "PNOC008-36"
```

Define directory
```{r define directory, include=FALSE}
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
data_dir <- file.path(root_dir, "data")

pediatric_dir <- file.path(root_dir, "graph-updates/plots/pediatric")
if (!dir.exists(pediatric_dir )) {
  dir.create(pediatric_dir , recursive = TRUE)
}

lollipop_dir <- file.path(pediatric_dir, "lollipop")
if (!dir.exists(lollipop_dir )) {
  dir.create(lollipop_dir , recursive = TRUE)
}

plotmaf_dir <- file.path(pediatric_dir, "plotmaf")
if (!dir.exists(plotmaf_dir )) {
  dir.create(plotmaf_dir , recursive = TRUE)
}

oncoplot_dir <- file.path(pediatric_dir, "oncoplot")
if (!dir.exists(oncoplot_dir )) {
  dir.create(oncoplot_dir , recursive = TRUE)
}

```

## P5 Pediatric Tumor Analysis - Mutational Analysis 
### Read in the data files
```{r read in for mutational analysis}
# read in PNOC008 combined maf 
consensus_maf_pnoc008 <- readRDS(file.path(data_dir, "pnoc008_consensus_maf_combined.rds"))

# read in PBTA maf 
consensus_maf_pbta <- readr::read_tsv(file.path(data_dir, "pbta-snv-consensus-mutation.maf.tsv.gz"))
```

Since the MAF object requires histology information, histology files for PNOC008 and pbta will be harmonized to a combined one - histology files downloaded from (s3://d3b-bix-dev-data-bucket/PNOC008/reference/pbta/pbta-histologies.tsv; s3://d3b-bix-dev-data-bucket/PNOC008/reference/pnoc008/pnoc008_clinical.rds)

```{r generated combined histology}
# generate a combined histology for PNOC008 and PBTA
histology<- readr::read_tsv(file.path(data_dir, "pbta-histologies.tsv"))
histology_pnoc008 <- readRDS(file.path(data_dir, "pnoc008_clinical.rds"))

histology_pnoc008 <- histology_pnoc008 %>% dplyr::rename(
  Participant_ID = subjectID,
  harmonized_diagnosis = tumorType,
  primary_site = tumorLocation,
  age_at_diagnosis_days = age_diagnosis_days, 
  reported_gender = sex, 
  cohort = study_id
) %>% select(-age_collection_days) %>% 
  select(-library_name)

histology <-  histology %>% dplyr::rename(Participant_ID = Kids_First_Participant_ID) %>%
  select(colnames(histology_pnoc008))
```

### Generate plots for recurrent alterations
#### Filter combined consensus MAF to recurrent alternated samples 
```{r filter MAF to samples in recurrent alterations list}
mutational_analysis <- readRDS(file.path(data_dir, "mutational_analysis_pediatric.rds"))

recurrent_alterations_all <- mutational_analysis$recurrent_alterations %>% 
  filter(Alteration_Datatype == "Mutation") %>% 
  pull(kids_first_biospecimen_id) %>% unique() 

recurrent_alterations_pbta <- recurrent_alterations_all[recurrent_alterations_all %in% consensus_maf_pbta$Tumor_Sample_Barcode]
recurrent_alterations_pnoc008 <- recurrent_alterations_all[!recurrent_alterations_all %in% consensus_maf_pbta$Tumor_Sample_Barcode]

# Use subject ID to filter pnoc008 combined consensus SNV
pnoc008_subject <- histology_pnoc008 %>% filter(Kids_First_Biospecimen_ID %in% recurrent_alterations_pnoc008) %>%
  pull(Participant_ID) %>% unique() %>%
  append(pnoc008_sample_of_interest)

# Check to see whether all the non-pbta subject are in consensus maf 
stopifnot(all(pnoc008_subject %in% consensus_maf_pnoc008$subjectID))

# Use the kids_first_biospecimen_id to filter pbta combined consensus SNV
matched_maf_pbta <- consensus_maf_pbta %>% filter(Tumor_Sample_Barcode %in% recurrent_alterations_pbta)

# filter based on subjectID
matched_maf_pnoc008 <- consensus_maf_pnoc008 %>% filter(subjectID %in% pnoc008_subject)

# merge the maf into one combined file
common_columns <- intersect(colnames(matched_maf_pbta), colnames(matched_maf_pnoc008))
matched_maf_pbta <- matched_maf_pbta %>% select(common_columns)
matched_maf_pnoc008 <- matched_maf_pnoc008 %>% select(common_columns)

combined_maf <- rbind(matched_maf_pbta, matched_maf_pnoc008)
```

#### Fix the histology for PNOC008 to use DNA samples as `Kids_First_Biospecimen_ID`
```{r filter histology to samples in recurrent alterations lists}
match_pnoc008 <- consensus_maf_pnoc008 %>% 
  select(subjectID, Tumor_Sample_Barcode) %>% distinct() %>%
  rename(Participant_ID = subjectID)

histology_pnoc008_recurrent <- histology_pnoc008 %>% 
  filter(Kids_First_Biospecimen_ID %in% recurrent_alterations_pnoc008) %>%
  left_join(match_pnoc008) %>%
  select(-Kids_First_Biospecimen_ID)
  
histology_recurrent <- histology %>% 
  filter(Kids_First_Biospecimen_ID %in% recurrent_alterations_pbta) %>%
  rename(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID)

dna_matched_histology <- rbind(histology_pnoc008_recurrent, histology_recurrent)
```


#### Clean up the MAF file and generate a MAF object
```{r generate MAF object ped recurrent}
combined_maf  <- combined_maf %>% rename(AAChange = HGVSp_Short) 

maf_object <- read.maf(maf = combined_maf , clinicalData = dna_matched_histology)
maf_object
```

#### Plot MAF Summary 
```{r plot MAF summary ped recurrent}
pdf(file.path(plotmaf_dir, "mutational_recurrent_pediatric.pdf"))
plotmafSummary(maf = maf_object, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
dev.off()

```

#### Generate lollipop plot 
```{r plot lollipop plot ped recurrent}
# First find the ten most mutated gene
summary_genes <- getGeneSummary(maf_object) %>% 
  arrange(desc(AlteredSamples)) 

# find the most mutated 10 genes
top10_gene_list <- summary_genes[1:10, ] %>% 
  pull(Hugo_Symbol) %>% unique()

top10_gene_list_position <- lapply(top10_gene_list, function(x) {
  protein_changes <- combined_maf %>% filter(Hugo_Symbol == x) %>% 
    filter(AAChange != ".") %>% 
    pull(AAChange)
  positions <- gsub(".*?([0-9]+).*", "\\1", protein_changes)
})

names(top10_gene_list_position) <- top10_gene_list 

pdf(file.path(lollipop_dir, "lollipop_recurrent_pediatric.pdf"), onefile = TRUE)
lapply(top10_gene_list, function(x){
  lollipopPlot(
  maf = maf_object,
  gene = x,
  showMutationRate = TRUE, 
  labelPos = top10_gene_list_position[[x]]
)
})
dev.off()

```


### Generate plots for shared mutations 

#### Filter combined consensus MAF to shared genes samples 
```{r filter MAF to samples in shared genes list}
shared_genes_all <- mutational_analysis$shared_genes %>% 
  filter(Alteration_Datatype == "Mutation") %>% 
  pull(kids_first_biospecimen_id) %>% unique() 

shared_genes_pbta <- shared_genes_all[shared_genes_all %in% consensus_maf_pbta$Tumor_Sample_Barcode]
shared_genes_pnoc008 <- shared_genes_all[!shared_genes_all %in% consensus_maf_pbta$Tumor_Sample_Barcode]

# Use the kids_first_biospecimen_id to filter pbta combined consensus SNV
matched_maf_pbta_shared <- consensus_maf_pbta %>% filter(Tumor_Sample_Barcode %in% shared_genes_pbta)

# For PNOC008 samples, we need to match back to the subject ID to filter for the MAF file 
# Use subject ID to filter pnoc008 combined consensus SNV
pnoc008_subject <- histology_pnoc008 %>% filter(Kids_First_Biospecimen_ID %in% shared_genes_pnoc008) %>%
  pull(Participant_ID) %>% unique() %>%
  append(pnoc008_sample_of_interest)

# Check to see whether all the non-pbta subject are in consensus maf 
stopifnot(all(pnoc008_subject %in% consensus_maf_pnoc008$subjectID))

# filter based on subjectID
matched_maf_pnoc008_shared <- consensus_maf_pnoc008 %>% filter(subjectID %in% pnoc008_subject)

# merge the maf into one combined file
matched_maf_pbta_shared <- matched_maf_pbta_shared %>% select(common_columns)
matched_maf_pnoc008_shared <- matched_maf_pnoc008_shared %>% select(common_columns)

combined_maf_shared <- rbind(matched_maf_pbta_shared, matched_maf_pnoc008_shared)
```

#### Fix the histology for PNOC008 to use DNA samples as `Kids_First_Biospecimen_ID`
```{r filter histology to samples in shared genes lists}
histology_pnoc008_shared <- histology_pnoc008 %>% 
  filter(Kids_First_Biospecimen_ID %in% shared_genes_pnoc008) %>%
  left_join(match_pnoc008) %>%
  select(-Kids_First_Biospecimen_ID)
  
histology_shared <- histology %>% 
  filter(Kids_First_Biospecimen_ID %in% shared_genes_pbta) %>%
  rename(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID)

dna_matched_histology_shared <- rbind(histology_pnoc008_shared, histology_shared)
```


#### Clean up the MAF file and generate a MAF object
```{r generate MAF object ped shared}
combined_maf_shared  <- combined_maf_shared %>% rename(AAChange = HGVSp_Short) 

maf_object <- read.maf(maf = combined_maf_shared , clinicalData = dna_matched_histology_shared)
maf_object
```

#### Plot MAF Summary 
```{r plot MAF summary ped shared}
pdf(file.path(plotmaf_dir, "mutational_shared_pediatric.pdf"))
plotmafSummary(maf = maf_object, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
dev.off()

```

#### Generate lollipop plot 
```{r plot lollipop plot ped shared}
# First find the ten most mutated gene
summary_genes <- getGeneSummary(maf_object) %>% 
  arrange(desc(AlteredSamples)) 

# find the most mutated 10 genes
top10_gene_list <- summary_genes[1:10, ] %>% 
  pull(Hugo_Symbol) %>% unique()

top10_gene_list_position <- lapply(top10_gene_list, function(x) {
  protein_changes <- combined_maf_shared %>% filter(Hugo_Symbol == x) %>% 
    filter(AAChange != ".") %>% 
    pull(AAChange)
  positions <- gsub(".*?([0-9]+).*", "\\1", protein_changes)
})

names(top10_gene_list_position) <- top10_gene_list 

pdf(file.path(lollipop_dir, "lollipop_shared_pediatric.pdf"))
lapply(top10_gene_list, function(x){
  lollipopPlot(
  maf = maf_object,
  gene = x,
  showMutationRate = TRUE, 
  labelPos = top10_gene_list_position[[x]]
)
})
dev.off()

```

### Generate oncoplots for CNV in recurrent alteration

#### First read in the CNV files
```{r read in CNV files}
pnoc008_cnv <- readRDS(file.path(data_dir, "pnoc008_cnv_filtered.rds"))
pbta_cnv <- readRDS(file.path(data_dir, "pbta-cnv-cnvkit-filtered.rds"))
```

#### Filter combined consensus MAF to recurrent CNV samples 
```{r filter MAF to samples in recurrent CNV list}
recurrent_cnv_all <- mutational_analysis$recurrent_alterations %>% 
  filter(Alteration_Datatype == "CNV") %>% 
  pull(kids_first_biospecimen_id) %>% unique() 

recurrent_cnv_pbta <- recurrent_cnv_all[recurrent_cnv_all %in% consensus_maf_pbta$Tumor_Sample_Barcode]
recurrent_cnv_pnoc008 <- recurrent_cnv_all[!recurrent_cnv_all %in% consensus_maf_pbta$Tumor_Sample_Barcode]

# Use the kids_first_biospecimen_id to filter pbta combined consensus SNV
matched_maf_pbta_recurrent_cnv <- consensus_maf_pbta %>% filter(Tumor_Sample_Barcode %in% recurrent_cnv_pbta)

# For PNOC008 samples, we need to match back to the subject ID to filter for the MAF file 
# Use subject ID to filter pnoc008 combined consensus SNV
pnoc008_subject <- histology_pnoc008 %>% filter(Kids_First_Biospecimen_ID %in% recurrent_cnv_pnoc008 ) %>%
  pull(Participant_ID) %>% unique() %>%
  append(pnoc008_sample_of_interest)

# filter based on subjectID
matched_maf_pnoc008_recurrent_cnv <- consensus_maf_pnoc008 %>% filter(subjectID %in% pnoc008_subject)

# merge the maf into one combined file
matched_maf_pbta_recurrent_cnv <- matched_maf_pbta_recurrent_cnv %>% select(common_columns)
matched_maf_pnoc008_recurrent_cnv <- matched_maf_pnoc008_recurrent_cnv %>% select(common_columns)

combined_maf_recurrent_cnv <- rbind(matched_maf_pbta_recurrent_cnv, matched_maf_pnoc008_recurrent_cnv)
```

#### Filter CNV files to contain only recurrent specimens
```{r filter CNV to samples in recurrent CNV lists}
pnoc008_cnv_recurrent <- pnoc008_cnv %>% 
  filter(SampleID %in% pnoc008_subject )
  
pbta_cnv_recurrent <- pbta_cnv %>% 
  filter(Kids_First_Biospecimen_ID %in% recurrent_cnv_pbta)

combined_cnv_recurrent <- rbind(pnoc008_cnv_recurrent, pbta_cnv_recurrent)
```

#### Clean up combined CNV recurrent 
```{r clean up combined recurrent cnv}
combined_cnv_recurrent <- combined_cnv_recurrent %>% 
  dplyr::mutate(CN = case_when(
    Alteration_Type == "Gain" ~ "ShallowAmp", 
    Alteration_Type == "Amplification" ~ "Amp", 
    Alteration_Type == "Loss" ~ "Del"
  )) %>% 
  dplyr::select(-Alteration_Type) %>%
  dplyr::rename(Sample_name = Kids_First_Biospecimen_ID) %>%
  dplyr::select(Gene, Sample_name, CN)

```

#### Generate MAF object with CNV data 
```{r generated MAF object with recurrent CNV}
maf_object_recurrent_cnv = read.maf(maf = combined_maf_recurrent_cnv, cnTable = combined_cnv_recurrent)

```

#### Plot Oncoplot 
```{r generated oncoplot for recurrent CNV}
pdf(file.path(oncoplot_dir, "mutational_cnv_recurrent_pediatric.pdf"))
oncoplot(maf = maf_object_recurrent_cnv, top=10)
dev.off()
```

### Generate oncoplots for CNV in shared genes
#### Filter combined consensus MAF to shared CNV samples 
```{r filter MAF to samples in shared CNV list}
shared_cnv_all <- mutational_analysis$shared_genes %>% 
  filter(Alteration_Datatype == "CNV") %>% 
  pull(kids_first_biospecimen_id) %>% unique() 

shared_cnv_pbta <- shared_cnv_all[shared_cnv_all %in% consensus_maf_pbta$Tumor_Sample_Barcode]
shared_cnv_pnoc008 <- shared_cnv_all[!shared_cnv_all %in% consensus_maf_pbta$Tumor_Sample_Barcode]

# Use the kids_first_biospecimen_id to filter pbta combined consensus SNV
matched_maf_pbta_shared_cnv <- consensus_maf_pbta %>% filter(Tumor_Sample_Barcode %in% shared_cnv_pbta)

# For PNOC008 samples, we need to match back to the subject ID to filter for the MAF file 
# Use subject ID to filter pnoc008 combined consensus SNV
pnoc008_subject <- histology_pnoc008 %>% filter(Kids_First_Biospecimen_ID %in% shared_cnv_pnoc008 ) %>%
  pull(Participant_ID) %>% unique() %>%
  append(pnoc008_sample_of_interest)

# filter based on subjectID
matched_maf_pnoc008_shared_cnv <- consensus_maf_pnoc008 %>% filter(subjectID %in% pnoc008_subject)

# merge the maf into one combined file
matched_maf_pbta_shared_cnv <- matched_maf_pbta_shared_cnv %>% select(common_columns)
matched_maf_pnoc008_shared_cnv <- matched_maf_pnoc008_shared_cnv %>% select(common_columns)

combined_maf_shared_cnv <- rbind(matched_maf_pbta_shared_cnv, matched_maf_pnoc008_shared_cnv)
```

#### Filter CNV files to contain only recurrent specimens
```{r filter CNV to samples shared CNV lists}
pnoc008_cnv_shared <- pnoc008_cnv %>% 
  filter(SampleID %in% pnoc008_subject )
  
pbta_cnv_shared <- pbta_cnv %>% 
  filter(Kids_First_Biospecimen_ID %in% shared_cnv_pbta)

combined_cnv_shared <- rbind(pnoc008_cnv_shared, pbta_cnv_shared)
```

#### Clean up combined CNV recurrent 
```{r clean up combined shared cnv}
combined_cnv_shared <- combined_cnv_shared %>% 
  dplyr::mutate(CN = case_when(
    Alteration_Type == "Gain" ~ "ShallowAmp", 
    Alteration_Type == "Amplification" ~ "Amp", 
    Alteration_Type == "Loss" ~ "Del"
  )) %>% 
  dplyr::select(-Alteration_Type) %>%
  dplyr::rename(Sample_name = Kids_First_Biospecimen_ID) %>%
  dplyr::select(Gene, Sample_name, CN)

```

#### Generate MAF object with CNV data 
```{r generated MAF object with shared CNV}
maf_object_shared_cnv = read.maf(maf = combined_maf_shared_cnv, cnTable = combined_cnv_shared)

```

#### Plot Oncoplot 
```{r generated oncoplot for shared CNV}
pdf(file.path(oncoplot_dir, "mutational_cnv_shared_pediatric.pdf"))
oncoplot(maf = maf_object_shared_cnv, top=10)
dev.off()
```